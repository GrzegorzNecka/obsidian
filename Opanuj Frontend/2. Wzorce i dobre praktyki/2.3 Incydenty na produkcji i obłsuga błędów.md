## Scenariusze z produkcji

W tej lekcji poznasz scenariusze, ktÃ³rych skuteczna obsÅ‚uga czÄ™sto decyduje o przyszÅ‚oÅ›ci firmy.

Kiedy liczba serwerÃ³w wzrasta, czasy odpowiedzi idÄ… w gÃ³rÄ™, a klientÃ³w przybywa, warto przygotowaÄ‡ siÄ™ na nieprzewidziane.

W tej lekcji zobaczysz, jak poradziÄ‡ sobie z utrzymaniem trudnego Å›rodowiska produkcyjnego.

### Jak wykorzystaÄ‡ statusy odpowiedzi HTTP

Na poczÄ…tku pracy z aplikacjami webowymi moÅ¼e siÄ™ wydawaÄ‡, Å¼e te niepozorne cyferki pojawiajÄ…ce siÄ™ obok odpowiedzi z serwera sÄ… bardziej ciekawostkÄ…, niÅ¼ narzÄ™dziem.

Wystarczy przecieÅ¼, Å¼e nauczymy siÄ™Â czterech prostych reguÅ‚:

- 2xx - zapytanie koÅ„czy siÄ™ sukcesem
- 3xx - zapytanie koÅ„czy siÄ™ przekierowaniem
- 4xx - bÅ‚Ä…d po stronie klienta
- 5xx - bÅ‚Ä…d po stronie serwera

Okazuje siÄ™Â jednak, Å¼e w duÅ¼ej skali, obsÅ‚ugujÄ…c tysiÄ…ce zapytaÅ„ dziennie, musimy na kody bÅ‚Ä™dÃ³w zwracaÄ‡ zdecydowanie wiÄ™kszÄ… uwagÄ™. W sytuacjach, kiedy wÅ‚Ä…czamy w naszej aplikacji monitoring i chcemy byÄ‡ powiadamiani o nagÅ‚ym wzroÅ›cie konkretnego typu bÅ‚Ä™du (**przedstawimy to w lekcjach moduÅ‚u trzeciego**), do Å›ledzenia kodÃ³w odpowiedzi musimy podejÅ›Ä‡ zdecydowanie bardziej szczegÃ³Å‚owo.

Zaprezentujemy to na przykÅ‚adzie kilku awarii, w ktÃ³rych braliÅ›my udziaÅ‚:

### **ğŸš¨ Incydent nr. 1 - Aktualizacja walidacji na serwerze (400 Bad Request)**

**Scenariusz**: ZespÃ³Å‚ backendowy aktualizuje serwis do walidacji jednego z formularzy na stronie. ZespÃ³Å‚ frontendowy nie jest Å›wiadomy tej zmiany, a monitoring wyÅ‚apuje wzrost bÅ‚Ä™dÃ³w z kodem 400.

**RozwiÄ…zanie**: ProgramiÅ›ci odkrywajÄ…, Å¼e bez aktualizacji frontendu wielu uÅ¼ytkownikÃ³w nie wpisuje danych do pola, ktÃ³re od teraz jest wymagane na backendzie. Backend zostaje przywrÃ³cony do poprzedniej wersji, aktualizowany jest formularz na frontendzie, a po pewnym czasie nowe reguÅ‚y wracajÄ… na serwer. W tej kolejnoÅ›ci wszystko zaczyna dziaÅ‚aÄ‡.

### **ğŸš¨ Incydent nr. 2 - Nowa metoda autoryzacji (401 Unauthorized)**

**Scenariusz**: ZespÃ³Å‚ wprowadza nowy system autoryzacji oparty na tokenach JWT. Po wdroÅ¼eniu, monitoring aplikacji zaczyna rejestrowaÄ‡ nagÅ‚y wzrost bÅ‚Ä™dÃ³w 401.

**RozwiÄ…zanie**: ProgramiÅ›ci szybko identyfikujÄ…, Å¼e nowy system autoryzacji wymaga odÅ›wieÅ¼enia tokenÃ³w w inny sposÃ³b niÅ¼ poprzedni. WprowadzajÄ… niezbÄ™dne zmiany w kodzie klienta, aby poprawnie obsÅ‚ugiwaÄ‡ nowy mechanizm odÅ›wieÅ¼ania tokenÃ³w.

### **ğŸš¨ Incydent nr. 3 - UsuniÄ™cie niepotrzebnej strony (404 Not Found)**

**Scenariusz**: W ramach porzÄ…dkowania projektu zespÃ³Å‚ usuwa starÄ… sekcjÄ™ serwisu, ktÃ³ra prawdopodobnie nie jest juÅ¼ uÅ¼ywana. WkrÃ³tce po tym, monitoring zgÅ‚asza wzrost bÅ‚Ä™dÃ³w 404 generowanych przez uÅ¼ytkownikÃ³w, ktÃ³rzy prÃ³bujÄ… na tÄ™ stronÄ™ wejÅ›Ä‡.

**RozwiÄ…zanie**: Po analizie logÃ³w, okazuje siÄ™, Å¼e inne czÄ™Å›ci serwisu nadal zawierajÄ… odnoÅ›niki do usuniÄ™tej strony. ZespÃ³Å‚ aktualizuje te linki, aby kierowaÅ‚y na istniejÄ…ce zasoby, oraz dodaje przekierowania 301 dla starych URLi, aby uniknÄ…Ä‡ negatywnego wpÅ‚ywu na SEO.

### **ğŸš¨ Incydent nr. 4 - BÅ‚Ä™dy w trakcie wdroÅ¼enia (500)**

**Scenariusz**: BezpoÅ›rednio po wdroÅ¼eniu nowej wersji aplikacji, system monitorujÄ…cy zaczyna rejestrowaÄ‡ wzrost bÅ‚Ä™dÃ³w 500.

**RozwiÄ…zanie**: ZespÃ³Å‚ przeprowadza analizÄ™ logÃ³w odkrywajÄ…c problem z niekompatybilnoÅ›ciÄ… nowego kodu z istniejÄ…cÄ… bazÄ… danych. Problem rozwiÄ…zano poprzez szybkÄ… naprawÄ™ kodu i ponowne wdroÅ¼enie.

### Kontrola nad kodami bÅ‚Ä™dÃ³w

Jako uczestnik kursu i frontend developer, moÅ¼esz nie mieÄ‡ bezpoÅ›redniej kontroli nad kodami bÅ‚Ä™dÃ³w generowanymi przez backend, ale twoja rola jest kluczowa w podnoszeniu ich znaczenia.

WspÃ³Å‚pracujÄ…c z zespoÅ‚em backendowym, moÅ¼esz podkreÅ›laÄ‡, jak waÅ¼ne jest dostarczanie szczegÃ³Å‚owych i precyzyjnych kodÃ³w, ktÃ³re pomagajÄ… w debugowaniu, poprawiajÄ… doÅ›wiadczenie uÅ¼ytkownika i uÅ‚atwiajÄ… obsÅ‚ugÄ™ bÅ‚Ä™dÃ³w po stronie klienta. W przypadkach, gdy peÅ‚nisz rolÄ™ full-stack developera, masz bezpoÅ›redni wpÅ‚yw na to, jakie kody bÅ‚Ä™dÃ³w sÄ… zwracane. MoÅ¼esz wtedy projektowaÄ‡ API w taki sposÃ³b, aby zapewniÄ‡, Å¼e kody bÅ‚Ä™dÃ³w sÄ… zarÃ³wno adekwatne do kontekstu, jak i pomocne w procesie rozwoju aplikacji oraz jej utrzymania.

TwÃ³j wpÅ‚yw na ten aspekt dziaÅ‚ania kodu server-side moÅ¼e znaczÄ…co przyczyniÄ‡ siÄ™ do zwiÄ™kszenia jakoÅ›ci i niezawodnoÅ›ci aplikacji webowych.

### **WymagajÄ…ca synchronizacja formatu danych**

RozwijajÄ…c i utrzymujÄ…c na produkcji aplikacje webowe, szczegÃ³lnie te, w ktÃ³rych sesja uÅ¼ytkownika trwa wiÄ™cej niÅ¼ kilka sekund, warto pamiÄ™taÄ‡ o **potencjalnych konfliktach na styku backendu i frontendu**. Jeden z takich konfliktÃ³w i jego rozwiÄ…zanie zobaczysz na poniÅ¼szym filmie:

ğŸ“ Ten przykÅ‚ad znajdziesz w folderze **_examples/module1/lesson4/api-contract_**.

**Kto i kiedy ma obsÅ‚ugiwaÄ‡ bÅ‚Ä™dy na styku frontendu i backendu?**

Na tym etapie wiesz juÅ¼ jak dziaÅ‚ajÄ… popularne natywne (fetch) i zewnÄ™trzne (axios) klienty http, do czego sÅ‚uÅ¼Ä… kody bÅ‚Ä™dÃ³w, a takÅ¼e na jakie scenariusze warto siÄ™ przygotowaÄ‡ pobierajÄ…c dane z backendu. Nietrudno zauwaÅ¼yÄ‡, Å¼e kiedy do gry wchodzi wiÄ™cej niÅ¼ jedna warstwa aplikacji, sprawy mogÄ… potoczyÄ‡ siÄ™ w wielu kierunkach.

==Nasza _frontendowa odpowiedzialnoÅ›Ä‡_ polega na tym, Å¼eby te najczÄ™Å›ciej wystÄ™pujÄ…ce scenariusze przewidzieÄ‡, a potencjalne bÅ‚Ä™dy opanowaÄ‡ w ten sposÃ³b, Å¼eby uÅ¼ytkownik nie frustrowaÅ‚ siÄ™ w trakcie korzystania z naszej aplikacji.

Pytanie brzmi - **gdzie wÅ‚aÅ›ciwie tÄ™ obsÅ‚ugÄ™ bÅ‚Ä™dÃ³w realizowaÄ‡?** Na poziomie klienta http? W funkcji korzystajÄ…cej z klienta http? A moÅ¼e w obu tych miejscach jednoczeÅ›nie? Czy powielanie konstrukcji try/catch jest akceptowalne, a moÅ¼e to _code smell_, ktÃ³rego powinniÅ›my unikaÄ‡?

==W praktyce okazuje siÄ™, Å¼e obsÅ‚uga bÅ‚Ä™dÃ³w to â€œficzerâ€ sam w sobie, a jego implementacja moÅ¼e rÃ³Å¼niÄ‡ siÄ™ w zaleÅ¼noÅ›ci od projektu czy konkretnych wymagaÅ„==. BÅ‚Ä™dy bÄ™dÄ… obsÅ‚ugiwane inaczej w zaleÅ¼noÅ›ci od tego, ==czy twÃ³rca klienta http zna kontekst, w ktÃ³rym jego klient bÄ™dzie uÅ¼ywany==, czy moÅ¼e go nie zna, bo tworzy bibliotekÄ™ Open Source uÅ¼ywanÄ… przez tysiÄ…ce firm na Å›wiecie. ObsÅ‚ugÄ™ bÅ‚Ä™dÃ³w moÅ¼emy teÅ¼ realizowaÄ‡ na kilku warstwach, a kaÅ¼da warstwa w procesie _error handlingu_ moÅ¼e mieÄ‡ do zrealizowania inne zadanie.

Dwa rÃ³wnorzÄ™dne scenariusze obsÅ‚ugi bÅ‚Ä™dÃ³w zobaczysz na poniÅ¼szym przykÅ‚adzie:

ğŸ“ Ten przykÅ‚ad znajdziesz w folderze **_examples/module1/lesson4/http-error-handling_**.


```tsx
import { getData } from './external-client';
import { getUsers } from './internal-client';

export function useClients() {
Â  const fetchUsingExternalClient = async () => {
Â  Â  try {
Â  Â  Â  await getData('/api/data/users?error=true');
Â  Â  } catch (error) {
Â  Â  Â  alert('Request has failed!');
Â  Â  }
Â  };

Â  const fetchUsingInternalClient = async () => {

Â  Â  try {
Â  Â  Â  await getUsers();
Â  Â  } catch (error) {
Â  Â  Â  alert('Request has failed!');
Â  Â  }

Â  };

Â  return {
Â  Â  fetchUsingExternalClient,
Â  Â  fetchUsingInternalClient,
Â  };
}

```
**external-client.ts**
```ts
import axios from 'axios';
export async function getData(apiUrl: string) {
Â  return await axios.get(apiUrl);
}
```
**internal-client.ts**
```tsx
import axios, { AxiosError } from 'axios';

const API_URL = '/api/data/users?error=true';

export async function getUsers() {
Â  try {
Â  Â  console.log(`Send analytics event about the following request: ${API_URL}`);
Â  Â  /* Reszta kodu zwiÄ…zanego z analitykÄ… */
Â  Â  // ...
Â  Â  /* ZwrÃ³cenie danych */
Â  Â  return await axios.get(API_URL);
Â  } catch (error) {

Â  Â  console.log(
Â  Â  Â  `Send analytics event about the following error: ${
Â  Â  Â  Â  (error as AxiosError).message
Â  Â  Â  } from ${API_URL}`
Â  Â  );

Â  Â  /* Reszta kodu zwiÄ…zanego z zalogowaniem bÅ‚Ä™du */
Â  Â  // ...

Â  Â  /* Przekazanie bÅ‚Ä™du do dalszej obsÅ‚ugi po stronie UI */
Â  Â  throw error;

Â  }

}
```

### **Idealny ksztaÅ‚t API frontendowego**

Jako frontend developerzy dÄ…Å¼ymy do tworzenia interfejsÃ³w, ktÃ³re komunikujÄ… siÄ™ z backendem w sposÃ³b optymalny i przemyÅ›lany. Teoretyczne zaÅ‚oÅ¼enia REST API, zakÅ‚adajÄ…ce bezstanowÄ… komunikacjÄ™ i jednolity ksztaÅ‚t endpointÃ³w, stanowiÄ… solidne fundamenty. W rzeczywistym Å›wiecie programowania zdarza siÄ™ jednak, Å¼e Å›cisÅ‚e trzymanie siÄ™ idealnego REST API moÅ¼e nie byÄ‡ najbardziej efektywne.

W takich przypadkach, warto rozwaÅ¼yÄ‡ dwa alternatywne podejÅ›cia do struktury API: **Data API** oraz **Application API**.

- **Data API** ==koncentruje siÄ™ na udostÄ™pnianiu zasobÃ³w jednego typu ==(zamÃ³wienie, produkt, uÅ¼ytkownik, etc.). Jest to podejÅ›cie zbliÅ¼one do klasycznych zaÅ‚oÅ¼eÅ„ REST, gdzie kaÅ¼da jednostka danych jest dostÄ™pna pod okreÅ›lonym endpointem, a operacje CRUD sÄ… Å‚atwo przewidywalne i standardowe. Taka struktura jest idealna, gdy aplikacja potrzebuje duÅ¼ej elastycznoÅ›ci w dostÄ™pie do danych, umoÅ¼liwiajÄ…c precyzyjne zarzÄ…dzanie danymi. Dodatkowo, jeÅ›li wystawiamy nasze API publicznie, to Data API rÃ³wnieÅ¼ sprawdzi siÄ™ tam znakomicie.
    
- **Application API** ==skupia siÄ™ na dostarczaniu danych specyficznych dla konkretnego fragmentu UI==. Zamiast udostÄ™pniania zasobÃ³w, endpointy sÄ… projektowane tak, aby odpowiadaÄ‡ na konkretne potrzeby interfejsu uÅ¼ytkownika, czyli np. zasilania tabeli, formularza czy listy i jej filtrÃ³w. Takie podejÅ›cie moÅ¼e znacznie zredukowaÄ‡ iloÅ›Ä‡ potrzebnych zapytaÅ„ sieciowych, zwiÄ™kszajÄ…c wydajnoÅ›Ä‡ aplikacji, szczegÃ³lnie w scenariuszach, gdzie frontend wymaga skomplikowanych zestawieÅ„ danych. W lekcji poÅ›wiÄ™conej warstwie **Backend-for-Fronend** przyjrzymy siÄ™ bliÅ¼ej wÅ‚aÅ›nieÂ temu stylowi budowania API.
    

WybÃ³r miÄ™dzy Data API a Application API powinien byÄ‡ podyktowany specyfikÄ… projektu oraz potrzebami uÅ¼ytkownika koÅ„cowego. W niektÃ³rych przypadkach, opÅ‚aca siÄ™ odejÅ›Ä‡ od teorii REST, aby dostosowaÄ‡ API do wymagaÅ„ wydajnoÅ›ciowych i uÅ¼ytkowych aplikacji. WaÅ¼ne jest, aby projektujÄ…c API, zawsze mieÄ‡ na uwadze cel, jakim jest zapewnienie najlepszej moÅ¼liwej interakcji uÅ¼ytkownika z aplikacjÄ….

## **Design for failure**

Design for Failure na frontendzie to podejÅ›cie, ktÃ³re zakÅ‚ada, Å¼e bÅ‚Ä™dy, awarie i nieprzewidziane sytuacje **sÄ… nieuniknionÄ… czÄ™Å›ciÄ… dziaÅ‚ania aplikacji webowej**. Zamiast prÃ³bowaÄ‡ stworzyÄ‡ system, ktÃ³ry nigdy nie zawiedzie (co jest praktycznie niemoÅ¼liwe), ==powinieneÅ› skupiÄ‡ siÄ™ na tworzeniu rozwiÄ…zaÅ„, ktÃ³re potrafiÄ… elegancko radziÄ‡ sobie z problemami, minimalizujÄ…c ich wpÅ‚yw na uÅ¼ytkownika koÅ„cowego==.

- Pierwszym krokiem w implementacji Design for Failure jest ==rozpoznanie **potencjalnych punktÃ³w awarii w aplikacji**.== MoÅ¼e to byÄ‡ na przykÅ‚ad nieudane zapytanie do API, bÅ‚Ä…d Å‚adowania zasobu, czy nieprzewidziane zachowanie uÅ¼ytkownika. Dla kaÅ¼dego z tych scenariuszy, ==warto zaimplementowaÄ‡ mechanizmy Å‚agodzenia skutkÃ³w, takie jak wyÅ›wietlanie wiadomoÅ›ci o bÅ‚Ä™dzie==, zapewnienie opcji ponownego wczytania zasobu, czy zastosowanie domyÅ›lnych wartoÅ›ci, ktÃ³re umoÅ¼liwiÄ… dalsze korzystanie z aplikacji.

- Kolejnym elementem jest ==budowanie **odpornych na bÅ‚Ä™dy interfejsÃ³w uÅ¼ytkownika**, ktÃ³re mogÄ… na przykÅ‚ad dynamicznie dostosowywaÄ‡ siÄ™ do zmieniajÄ…cych siÄ™ danych==. PrzykÅ‚adowo, jeÅ›li aplikacja polega na danych z zewnÄ™trznego API, ktÃ³re moÅ¼e byÄ‡ czasowo niedostÄ™pne,==interfejs powinien umoÅ¼liwiaÄ‡ uÅ¼ytkownikowi sensownÄ… interakcjÄ™ z aplikacjÄ…, nawet bez tych danych==. MoÅ¼e to oznaczaÄ‡ wykorzystanie tzw. â€œ**skeleton screens**â€, czyli komponentÃ³w sugerujÄ…cych Å‚adowanie treÅ›ci, zamiast pokazywania pustych ekranÃ³w lub bÅ‚Ä™dÃ³w. ZapamiÄ™tywanie chwilowo niedostÄ™pnych danych mogÄ… teÅ¼ zapewniaÄ‡ [Service Workery](https://web.dev/learn/pwa/service-workers?hl=en).

Omawiane w drugim module ==testowanie to rÃ³wnieÅ¼ element podejÅ›cia Design for Failure==. Obejmuje ono nie tylko testy jednostkowe i integracyjne, ale rÃ³wnieÅ¼ testy wydajnoÅ›ciowe, testy obciÄ…Å¼eniowe oraz testowanie zachowania aplikacji w nietypowych warunkach. W kontekÅ›cie komunikacji z API, niektÃ³re firmy decydujÄ… siÄ™ na tzw. â€œ[chaos testing](https://netflix.github.io/chaosmonkey/)â€, czyli obserwowanie zachowania aplikacji po umyÅ›lnym wyÅ‚Ä…czeniu z ruchu wybranych serwisÃ³w backendowych.

Ostatnim, ale rÃ³wnie waÅ¼nym elementem, jest **edukacja uÅ¼ytkownikÃ³w**. WskazÃ³wki dotyczÄ…ce rozwiÄ…zywania problemÃ³w, czÄ™sto zadawane pytania (**FAQ**) czy nawet **proste komunikaty o bÅ‚Ä™dach** mogÄ… znaczÄ…co poprawiÄ‡ doÅ›wiadczenie uÅ¼ytkownika w obliczu awarii. DziÄ™ki temu uÅ¼ytkownik nie tylko rozumie, co siÄ™ dzieje, ale rÃ³wnieÅ¼ wie, co moÅ¼e zrobiÄ‡, aby kontynuowaÄ‡ pracÄ™ z aplikacjÄ….

PamiÄ™taj, Å¼e w duÅ¼ej skali celem nie jest zredukowanie bÅ‚Ä™dÃ³w do zera (trudne do osiÄ…gniÄ™cia), ale zapewnienie, Å¼e gdy coÅ› pÃ³jdzie nie tak, aplikacja i jej uÅ¼ytkownicy sÄ… na to gotowi.

## JakoÅ›ciowa komunikacja z API

W drugim module naszego szkolenia poznasz kolejne sposoby na bezpiecznÄ… integracjÄ™ frontendu z backendem. Przedstawimy tam m.in.:

- Standard [OpenAPI](https://swagger.io/specification/)
- Automatyczne generowanie klientÃ³w HTTP
- WalidacjÄ™ danych z bibliotekÄ… [Zod](https://zod.dev/)
- Integrowanie warstw aplikacji poprzez [tRPC](https://trpc.io/)
- Porady projektowe z systemu UNIX

Trzymamy kciuki za dalszÄ… naukÄ™ ze szkoleniem Opanuj Frontend!

---


## ğŸ“š MateriaÅ‚y dodatkowe

PoniÅ¼ej znajdziesz materiaÅ‚y poszerzajÄ…ce wiedzÄ™ zawartÄ… w tej lekcji:

- Optymalne API - [https://max.engineer/server-informed-ui](https://max.engineer/server-informed-ui)